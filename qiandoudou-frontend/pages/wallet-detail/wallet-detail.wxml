<!--pages/wallet-detail/wallet-detail.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨é’±åŒ…èƒŒæ™¯åŒºåŸŸ -->
  <view class="wallet-header-section">
    <!-- èƒŒæ™¯å›¾ç‰‡å’Œé®ç½© -->
    <view class="wallet-background" style="{{walletBackgroundStyle}}" bindtap="{{isOwnWallet ? 'showBackgroundModal' : ''}}">
      <view class="background-overlay"></view>
      
      <!-- èƒŒæ™¯ç‚¹å‡»æç¤ºï¼ˆåªåœ¨è‡ªå·±é’±åŒ…æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{showBackgroundHint && isOwnWallet}}" class="background-hint">
        <text class="hint-text">ç‚¹å‡»æ›´æ¢èƒŒæ™¯</text>
      </view>
      
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <view class="header-nav">
        <view class="nav-left" bindtap="goBackToWalletList">
          <view class="back-icon"></view>
        </view>
      </view>
      
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info" catchtap="stopPropagation">
        <view class="user-avatar">
          <text class="avatar-text">{{wallet.name ? wallet.name.charAt(0) : 'U'}}</text>
        </view>
        <view class="user-details">
          <text class="user-title" bindtap="{{isOwnWallet ? 'editWalletName' : ''}}">{{wallet.name || 'é’±å…œå…œ'}}ğŸ’—</text>
          <text class="user-tags">#{{wallet.type === 2 ? 'æƒ…ä¾£' : 'ä¸ªäºº'}} #æ”’é’± #{{wallet.ai_partner_name || 'ç†è´¢'}}</text>
          <text class="user-desc">{{wallet.owner_nickname || wallet.name || 'ç”¨æˆ·'}}çš„é’±å…œå…œï¼Œå½“å‰ä½™é¢ Â¥{{wallet.balance || '0.00'}}</text>
        </view>
      </view>
      
      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="stats-info" catchtap="stopPropagation">
        <view class="stat-item">
          <text class="stat-number">{{socialStats.fansCount !== undefined ? socialStats.fansCount : (wallet.followers_count || 0)}}</text>
          <text class="stat-label">ç²‰ä¸</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{socialStats.likesCount !== undefined ? socialStats.likesCount : (wallet.likes_count || 0)}}</text>
          <text class="stat-label">è·èµ</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{socialStats.viewsCount !== undefined ? socialStats.viewsCount : 0}}</text>
          <text class="stat-label">æµè§ˆ</text>
        </view>
        

      </view>
      
      <!-- å…³æ³¨æŒ‰é’®ï¼ˆåœ¨èƒŒæ™¯å›¾å³ä¸‹è§’ï¼‰ -->
      <view wx:if="{{fromSocial && !isOwnWallet}}" class="follow-button-corner">
        <image class="follow-btn-image {{isFollowing ? 'following' : ''}}" 
               src="{{isFollowing ? '/images/res/ä¸ªäººä¸»è¯¦æƒ…/png/å·²å…³æ³¨.png' : '/images/res/ä¸ªäººä¸»è¯¦æƒ…/png/å…³æ³¨.png'}}" 
               bindtap="toggleFollow"
               mode="aspectFit" />
      </view>
    </view>
    
    <!-- æ€»é‡‘é¢å¡ç‰‡ -->
    <view class="total-amount-card" catchtap="stopPropagation">
      <text class="amount-label">æ€»é‡‘é¢ï¼ˆå…ƒï¼‰</text>
      <text class="amount-value">{{wallet.balance !== undefined ? wallet.balance : '0.00'}}</text>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view wx:if="{{isOwnWallet}}" class="operation-section" catchtap="stopPropagation">
    <!-- ç¬¬ä¸€è¡Œï¼šè½¬å…¥å’Œè½¬å‡º -->
    <view class="operation-buttons">
      <view class="operation-btn" bindtap="goToTransferIn">
        <text class="btn-text">è½¬å…¥</text>
      </view>
      <view class="operation-btn" bindtap="goToTransferOut">
        <text class="btn-text">è½¬å‡º</text>
      </view>
    </view>
    
    <!-- ç¬¬äºŒè¡Œï¼šå‰§æœ¬æ”’ -->
    <view class="script-button-row">
      <view class="script-btn" bindtap="goToScripts">
        <text class="script-btn-text">å‰§æœ¬æ”’</text>
      </view>
    </view>
  </view>
  

  
  <!-- å‰§æœ¬æ¨å¹¿å¡ç‰‡ï¼ˆåªåœ¨è‡ªå·±é’±åŒ…æ—¶æ˜¾ç¤ºï¼‰ -->
  <view wx:if="{{showPromoCard && isOwnWallet}}" class="script-promotion">
    <view class="promo-card">
      <view class="promo-image-placeholder">
        <text class="image-icon">ğŸ®</text>
      </view>
      <view class="promo-content">
        <text class="promo-title">è¶…çº§ç›ä¸½å¤šæ‹çˆ±å°äº‹</text>
        <text class="promo-desc">æ‰“å¡è¶…çº§ç›ä¸½å¤š</text>
      </view>
      <view class="promo-action">
        <view class="close-btn" bindtap="closePromo">
          <text class="close-icon">Ã—</text>
        </view>
        <view class="action-btn-promo">
          <text class="action-text">å»é—¯å…³</text>
        </view>
      </view>
    </view>
  </view>
  


  <!-- è´¦å•å’Œç»Ÿè®¡ -->
  <view class="bill-section">
    <!-- æ ‡ç­¾åˆ‡æ¢ï¼ˆæ¥è‡ªç¤¾äº¤åœˆæ—¶ç®€åŒ–æ˜¾ç¤ºï¼‰ -->
    <view class="tab-bar">
      <view class="tab-item {{activeTab === 'bill' ? 'active' : ''}}" bindtap="{{isOwnWallet ? 'switchTab' : ''}}" data-tab="bill">
        <text class="tab-text">è´¦å•</text>
      </view>
      <!-- ç»Ÿè®¡æ ‡ç­¾ï¼ˆåªåœ¨è‡ªå·±é’±åŒ…æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{isOwnWallet}}" class="tab-item {{activeTab === 'stats' ? 'active' : ''}}" bindtap="switchTab" data-tab="stats">
        <text class="tab-text">ç»Ÿè®¡</text>
      </view>
      <!-- è¿‡æ»¤æŒ‰é’®ï¼ˆåªåœ¨è‡ªå·±é’±åŒ…æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{isOwnWallet}}" class="filter-btn" bindtap="showFilter">
        <text class="filter-text">è¿‡æ»¤</text>
        <text class="filter-icon">ğŸ”½</text>
      </view>
    </view>
    
    <!-- è´¦å•åˆ—è¡¨ï¼ˆç¤¾äº¤åŠ¨æ€æµæ°´ï¼‰ -->
    <view wx:if="{{activeTab === 'bill'}}" class="bill-list">
      <view wx:for="{{transactions}}" wx:key="id" class="social-bill-item">
        <!-- ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
        <view class="user-header">
          <!-- AIä¼´ä¾£å¤´åƒæˆ–ç”¨æˆ·å¤´åƒ -->
          <view class="user-avatar-small">
            <image wx:if="{{item.isAiTransaction && item.aiPartnerAvatar}}" 
                   class="ai-avatar-image" 
                   src="{{item.aiPartnerAvatar}}" 
                   mode="aspectFill"></image>
            <text wx:else class="avatar-text">{{wallet.name ? wallet.name.charAt(0) : 'U'}}</text>
          </view>
          <view class="transaction-info">
            <!-- æ ‡é¢˜å•ç‹¬ä¸€è¡Œï¼ŒåŠ ç²— - æ˜¾ç¤ºAIä¼´ä¾£åç§°æˆ–é’±åŒ…åç§° -->
            <view class="title-row">
              <text class="transaction-title">{{item.isAiTransaction ? item.aiPartnerName : (wallet.name || 'é’±å…œå…œ')}}</text>
              <view class="transaction-amount">
                <text class="amount-display {{item.type === 1 ? 'income' : 'expense'}}">
                  {{item.type === 1 ? '+' : ''}}{{item.amount}}
                </text>
              </view>
            </view>
            <!-- æµæ°´ç±»å‹å•ç‹¬ä¸€è¡Œ -->
            <view class="subtitle-row">
              <text class="transaction-subtitle">{{item.subtitle}}</text>
            </view>
          </view>
        </view>
        
        <!-- äº¤æ˜“æ—¶é—´ï¼ˆç©ºä¸€è¡Œåæ˜¾ç¤ºï¼‰ -->
        <view class="transaction-time">
          <text class="time-text">{{item.create_time}}</text>
        </view>
        
        <!-- AIä¼´ä¾£æ¶ˆæ¯å†…å®¹ï¼ˆå¦‚æœæ˜¯AIäº¤æ˜“ï¼‰ -->
        <view wx:if="{{item.isAiTransaction && item.aiMessage}}" class="ai-message-content">
          <text class="ai-message-text">{{item.aiMessage}}</text>
          <!-- è¯­éŸ³æ’­æ”¾æŒ‰é’®ï¼ˆAIä¼´ä¾£æ¶ˆæ¯æ€»æ˜¯æ˜¾ç¤ºè¯­éŸ³æ’­æ”¾æŒ‰é’®ï¼‰ -->
          <view class="voice-play-section">
            <view class="voice-play-btn {{item.isPlaying ? 'playing' : ''}}" 
                  bindtap="playAiVoice" 
                  data-transaction="{{item}}">
              <text class="voice-icon">ğŸµ</text>
              <text class="voice-duration">{{item.voiceDuration || '12s'}}</text>
            </view>
          </view>
        </view>
        
        <!-- å¤‡æ³¨å†…å®¹ï¼ˆå¦‚æœæœ‰ä¸”ä¸æ˜¯AIäº¤æ˜“ï¼‰ -->
        <view wx:if="{{!item.isAiTransaction && item.note}}" class="transaction-note">
          <text class="note-text">{{item.note}}</text>
        </view>
        
        <!-- å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰ -->
        <view wx:if="{{item.imageUrl}}" class="transaction-image">
          <image class="note-image" src="{{item.imageUrl}}" mode="aspectFill"></image>
        </view>
        
        <!-- ç¤¾äº¤äº’åŠ¨æŒ‰é’®ï¼ˆåªåœ¨æ¥è‡ªç¤¾äº¤åœˆæ—¶æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{fromSocial}}" class="social-actions">
          <view class="action-btn {{item.isLiked ? 'liked' : ''}}" bindtap="toggleLike" data-transaction="{{item}}">
            <text class="action-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="action-text">{{item.likeCount || 0}}</text>
          </view>
          <view class="action-btn" bindtap="showComments" data-transaction="{{item}}">
            <text class="action-icon">ğŸ’¬</text>
            <text class="action-text">{{item.commentCount || 0}}</text>
          </view>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ï¼ˆæ˜¾ç¤ºåœ¨æµæ°´ä¸‹é¢ï¼‰ -->
        <view wx:if="{{item.comments && item.comments.length > 0}}" class="transaction-comments">
          <view wx:for="{{item.comments}}" wx:key="id" wx:for-item="comment" class="comment-item-inline">
            <view class="comment-user-inline">
              <text class="comment-username-inline">{{comment.userName}}ï¼š</text>
            </view>
            <text class="comment-content-inline">{{comment.content}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç»Ÿè®¡è§†å›¾ -->
    <view wx:if="{{activeTab === 'stats'}}" class="stats-view">
      <text class="stats-placeholder">ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­...</text>
    </view>
  </view>

  <!-- è½¬è´¦å¯¹è¯æ¡† -->
  <view wx:if="{{showTransferModal}}" class="modal-overlay" bindtap="hideTransferModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{transferType === 'in' ? 'è½¬å…¥èµ„é‡‘' : 'è½¬å‡ºèµ„é‡‘'}}</text>
        <text class="modal-close" bindtap="hideTransferModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">é‡‘é¢</text>
          <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥é‡‘é¢" bindinput="onAmountInput" value="{{transferForm.amount}}" />
        </view>
        
        <view class="form-item">
          <text class="form-label">è¯´æ˜</text>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥è½¬è´¦è¯´æ˜" bindinput="onDescriptionInput" value="{{transferForm.description}}" maxlength="100"></textarea>
        </view>
        
        <view wx:if="{{transferType === 'out'}}" class="balance-tip">
          å½“å‰ä½™é¢ï¼šÂ¥{{wallet.balance}}
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideTransferModal">å–æ¶ˆ</button>
        <button class="btn-confirm" bindtap="handleTransfer" disabled="{{transferLoading}}">
          {{transferLoading ? 'å¤„ç†ä¸­...' : (transferType === 'in' ? 'ç¡®è®¤è½¬å…¥' : 'ç¡®è®¤è½¬å‡º')}}
        </button>
      </view>
    </view>
  </view>

  <!-- æ›´æ¢èƒŒæ™¯å¯¹è¯æ¡† -->
  <view wx:if="{{showBackgroundModal}}" class="modal-overlay" bindtap="hideBackgroundModal">
    <view class="modal-content background-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ›´æ¢é’±åŒ…èƒŒæ™¯</text>
        <text class="modal-close" bindtap="hideBackgroundModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <!-- è‡ªå®šä¹‰å›¾ç‰‡ä¸Šä¼  -->
        <view class="upload-section">
          <text class="section-title">è‡ªå®šä¹‰èƒŒæ™¯</text>
          <view class="upload-option" bindtap="uploadCustomImage">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡</text>
          </view>
        </view>
        
        <!-- é¢„è®¾æ¸å˜èƒŒæ™¯ -->
        <view class="gradient-section">
          <text class="section-title">é¢„è®¾èƒŒæ™¯</text>
          <view class="background-options">
            <view wx:for="{{backgroundOptions}}" wx:key="value" 
                  class="background-option {{selectedBackground === item.value ? 'selected' : ''}}"
                  style="{{item.gradient}}"
                  bindtap="selectBackground" 
                  data-value="{{item.value}}">
              <text class="option-name">{{item.name}}</text>
              <text wx:if="{{selectedBackground === item.value}}" class="selected-check">âœ“</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideBackgroundModal">å–æ¶ˆ</button>
        <button class="btn-confirm" 
                bindtap="changeBackground" 
                disabled="{{backgroundLoading}}">
          {{backgroundLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
        </button>
      </view>
    </view>
  </view>

  <!-- é’±åŒ…åç§°ç¼–è¾‘å¯¹è¯æ¡† -->
  <view wx:if="{{showNameEditModal}}" class="modal-overlay" bindtap="hideNameEditModal">
    <view class="modal-content name-edit-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ä¿®æ”¹é’±åŒ…åç§°</text>
        <text class="modal-close" bindtap="hideNameEditModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">é’±åŒ…åç§°</text>
          <input class="form-input" 
                 type="text" 
                 placeholder="è¯·è¾“å…¥é’±åŒ…åç§°" 
                 value="{{editingName}}" 
                 bindinput="onNameInput" 
                 maxlength="20" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideNameEditModal">å–æ¶ˆ</button>
        <button class="btn-confirm" bindtap="confirmNameEdit">
          ç¡®è®¤ä¿®æ”¹
        </button>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºå¯¹è¯æ¡† -->
  <view wx:if="{{showCommentModal}}" class="modal-overlay" bindtap="hideCommentModal">
    <view class="modal-content comment-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è¯„è®º</text>
        <text class="modal-close" bindtap="hideCommentModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <!-- ç°æœ‰è¯„è®ºåˆ—è¡¨ -->
        <view wx:if="{{currentComments.length > 0}}" class="comments-list">
          <view wx:for="{{currentComments}}" wx:key="id" class="comment-item">
            <view class="comment-user">
              <view class="comment-avatar">
                <text class="avatar-text">{{item.userName ? item.userName.charAt(0) : 'U'}}</text>
              </view>
              <text class="comment-username">{{item.userName || 'ç”¨æˆ·'}}</text>
              <text class="comment-time">{{item.time}}</text>
            </view>
            <text class="comment-content">{{item.content}}</text>
          </view>
        </view>
        
        <!-- æ— è¯„è®ºæç¤º -->
        <view wx:if="{{currentComments.length === 0}}" class="no-comments">
          <text class="no-comments-text">æš‚æ— è¯„è®º</text>
        </view>
        
        <!-- è¯„è®ºè¾“å…¥ -->
        <view class="comment-input-section">
          <textarea class="comment-input" 
                    placeholder="è¯´ç‚¹ä»€ä¹ˆ..." 
                    value="{{commentText}}" 
                    bindinput="onCommentInput"
                    maxlength="200"
                    auto-focus="true"></textarea>
          <view class="comment-actions">
            <text class="char-count">{{commentText.length}}/200</text>
            <button class="send-comment-btn" 
                    bindtap="sendComment" 
                    disabled="{{commentText.length === 0 || commentLoading}}">
              {{commentLoading ? 'å‘é€ä¸­...' : 'å‘é€'}}
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>